---
version: '3.7'
services:
  pmm-managed-server:
    image: ${PMM_SERVER_IMAGE:-perconalab/pmm-server:dev-latest}
    container_name: pmm-managed-server
    hostname: pmm-managed-server
    environment:
      - PATH=/root/go/bin:$PATH
      - GO_VERSION=${GO_VERSION:-1.13.x}
      - CI_REPO_OWNER=${CI_REPO_OWNER}
      - CI_REPO_NAME=${CI_REPO_NAME}
      - CI_PULL_REQUEST=${CI_PULL_REQUEST}
      - CI_COMMIT=${CI_COMMIT}
      - CI_BRANCH=${CI_BRANCH}
      - REVIEWDOG_GITHUB_API_TOKEN=${REVIEWDOG_GITHUB_API_TOKEN}

    # for delve
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined

    ports:
      - 127.0.0.1:80:80
      - 127.0.0.1:443:443
    volumes:
      - .:/root/go/src/github.com/percona/pmm-managed
      - ./Makefile.devcontainer:/root/go/src/github.com/percona/pmm-managed/Makefile:ro
